name: "release"

on:
  push:
    branches:
      - "master"
    tags:
      - "v*"

jobs:
  build:
    name: "build"
    runs-on: "windows-2022"

    steps:
      - name: set up Cygwin
        uses: egor-tensin/setup-cygwin@v4
        with:
          platform: x64
          packages: make zip

      - name: checkout
        uses: actions/checkout@v4

      - name: build
        run: |
          make.exe genzip

      - name: create installer
        uses: joncloud/makensis-action@v4.1
        with:
          arguments: "/V3"

      - name: compress installer (for BOOTH)
        run: |
          zip.exe VRChatRejoinTool.Installer.BOOTH.zip VRChatRejoinTool.Installer.exe

      - name: pre-release
        uses: softprops/action-gh-release@v2.0.6
        with:
          tag_name: "latest"
          prerelease: true
          name: "Development Build"
          files: |
            VRChatRejoinTool.zip
            VRChatRejoinTool.Installer.exe
            VRChatRejoinTool.Installer.BOOTH.zip

      - name: tagged-release
        uses: softprops/action-gh-release@v2.0.6
        if: startsWith(github.ref, 'refs/tags/')
        with:
          files: |
            VRChatRejoinTool.zip
            VRChatRejoinTool.Installer.exe
            VRChatRejoinTool.Installer.BOOTH.zip

